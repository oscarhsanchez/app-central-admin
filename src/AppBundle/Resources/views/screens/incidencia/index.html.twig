{% extends 'base.html.twig' %}

{% block page_title %}{{ 'menu.title.issues'|trans }}{% endblock %}
{% block page_breadcrumb %}
    <li>{{ 'menu.title.configuration'|trans }}</li>
    <li class="active">
        <strong>
            {{ 'menu.title.issues'|trans }}
            {% if type == 'fixing' %}
                - {{ 'menu.title.issue_fixing'|trans }}
            {% elseif type == 'monitoring' %}
                - {{ 'menu.title.issue_monitoring'|trans }}
            {% elseif type == 'installation' %}
                - {{ 'menu.title.issue_installation'|trans }}
            {% elseif type == 'lighting' %}
                - {{ 'menu.title.issue_lighting'|trans }}
            {% elseif type == 'plane' %}
                - {{ 'menu.title.issue_plane'|trans }}
            {% elseif type == 'others' %}
                - {{ 'menu.title.issue_others'|trans }}
            {% endif %}
        </strong>
    </li>
{% endblock %}

{% block body %}
    <div class="ibox">

        <div class="ibox-title">
            <h5>{{ 'menu.title.issues'|trans }}</h5>
        </div>
        <div class="ibox-content">

            {% include 'ESocialUtilBundle:flash-messages:_flash.messages.html.twig' %}

            <div class="margin-b">
                <a class="btn btn-white" title="{{ 'incidencia.buttons.add'|trans }}" href="{{ path('incidencia_add', { type: type }) }}">
                    <span class="glyphicon glyphicon-plus"></span>
                    <strong>{{ 'incidencia.buttons.add'|trans }}</strong>
                </a>
                <a class="btn btn-white" title="{{ 'incidencia.buttons.change_user'|trans }}" href="{{ path('incidencia_edit_field', { type: type, field_type: 'user' }) }}" onclick="loadAjaxFormPage(this, null, null, incidencia_list_reload); return false;">
                    <span class="glyphicon glyphicon-plus"></span>
                    <strong>{{ 'incidencia.buttons.change_user'|trans }}</strong>
                </a>
                <a class="btn btn-white" title="{{ 'incidencia.buttons.date_limit'|trans }}" href="{{ path('incidencia_edit_field', { type: type, field_type: 'date_limit' }) }}" onclick="loadAjaxFormPage(this, null, null, incidencia_list_reload); return false;">
                    <span class="glyphicon glyphicon-plus"></span>
                    <strong>{{ 'incidencia.buttons.change_date_limit'|trans }}</strong>
                </a>
                <a class="btn btn-white" title="{{ 'incidencia.buttons.state'|trans }}" href="{{ path('incidencia_edit_field', { type: type, field_type: 'state' }) }}" onclick="loadAjaxFormPage(this, null, null, incidencia_list_reload); return false;">
                    <span class="glyphicon glyphicon-plus"></span>
                    <strong>{{ 'incidencia.buttons.change_state'|trans }}</strong>
                </a>
            </div>

            <table id="dt-incidencia-list" class="table table-striped table-bordered table-hover">
                <thead>
                <tr>
                    <th class="datatable-chk-cell"><input type="checkbox" class="i-checks datatable-chk-select-all" value="all" /></th>
                    <th>{{ 'form.incidencia.label.medio'|trans }}</th>
                    <th>{{ 'form.incidencia.label.codigo_user'|trans }}</th>
                    <th>{{ 'form.incidencia.label.codigo_user_asignado'|trans }}</th>
                    <th>{{ 'form.incidencia.label.tipo'|trans }}</th>
                    <th>{{ 'form.incidencia.label.estado_incidencia'|trans }}</th>
                    <th>{{ 'form.incidencia.label.fecha_limite'|trans }}</th>
                    <th>{{ 'form.incidencia.label.fecha_cierre'|trans }}</th>
                    <th>{{ 'form.label.actions'|trans }}</th>
                </tr>
                </thead>
            </table>

        </div>

    </div>

    <script type="text/javascript">
        var incidencia_list = null;

        var params = {
            dom: '<"clearfix" lf>r<"tablePrint" t>ip',
            fnDrawCallback: function ( settings ) {
                var api = this.api();
                var filterWrapper = $('#dt-incidencia-list_filter');
                if ($('#dt-incidencia-list_filter-tipo-wrapper').length < 1) {
                    $(filterWrapper).append(
                            '<div id="dt-incidencia-list_filter-tipo-wrapper" class="row pull-right" style="margin-right: 20px; margin-bottom: 15px">' +
                                '<div class="col-md-6">' +
                                    '<div class="form-group">' +
                                        '<select onchange="incidencia_list_reload()" id="dt-incidencia-list_filter-tipo" class="form-control"><option value="" selected="selected">{{ 'form.incidencia.label.tipo.select_tipo'|trans }}</option><option value="0">{{ 'form.incidencia.label.tipo.lighting'|trans }}</option><option value="1">{{ 'form.incidencia.label.tipo.fixing'|trans }}</option><option value="2">{{ 'form.incidencia.label.tipo.installation'|trans }}</option><option value="3">{{ 'form.incidencia.label.tipo.others'|trans }}</option></select>'+
                                    '</div>' +
                                '</div>' +
                            '</div>'
                    );
                    initPage($(filterWrapper));
                }
            }
        };

        $(document).ready(function() {
            var table_columns = [
                {
                    "mData": function (source) {
                        return '<input type="checkbox" class="i-checks" value="'+source.token+'" />';
                    }
                },
                {"mData": "medio__ubicacion__ubicacion"},
                {"mData": "codigo_user"},
                {"mData": "codigo_user_asignado"},
                {"mData": "tipo"},
                {"mData": "estado_incidencia"},
                {"mData": "fecha_limite"},
                {"mData": "fecha_cierre"},
                {
                    "mData": function (source){
                        var actions = '<a class="btn btn-primary btn-xs" href="' + Routing.generate('incidencia_edit', { _locale: '{{ app.request.locale }}', type: '{{ type }}', id: encodeURIComponent(source.token) }) + '"><span class="glyphicon glyphicon-edit"></span> &nbsp; {{ 'form.actions.edit'|trans }}</a>&nbsp; ';
                        actions += '<a class="btn btn-primary btn-xs" title="{{ 'incidencia.buttons.view_log'|trans }}" href="' + Routing.generate('incidencia_view_log', { _locale: '{{ app.request.locale }}', type: '{{ type }}', id: encodeURIComponent(source.token) }) + '" onclick="loadAjaxPage(this); return false;"><span class="glyphicon glyphicon-edit"></span> &nbsp; {{ 'incidencia.buttons.view_log'|trans }}</a>&nbsp; ';
                        actions += '<a class="btn btn-primary btn-xs" href="javascript:void(0)" onclick="bootbox.confirm(\'Seguro que desea eliminar el registro?\', function(confirmed){ if(confirmed) executeAjax(\'' + Routing.generate('incidencia_delete', { _locale: '{{ app.request.locale }}', id: encodeURIComponent(source.token), type: '{{ type }}' }) + '\', null, null, incidencia_list_reload); }); return false;"><span class="glyphicon glyphicon-remove"></span> &nbsp; {{ 'form.actions.delete'|trans }}</a>&nbsp; ';
                        return actions;
                    }
                }
            ];

            jQuery(document).ready(function(){
                incidencia_list = TableManaged.init(
                        '#dt-incidencia-list',
                        '{{ url('incidencia_list_json', { _type: type }) }}',
                        params,
                        [],
                        table_columns,
                        '{{ url('datatables_i18n_fragment', { language: app.request.locale }) }}'
                );
            });
        });

        function incidencia_list_reload(result){
            if (result && result.message){
                var alertType = result.result == 1 ? 'success' : 'danger';
                $(incidencia_list).closest('.dataTables_wrapper').prepend(Notification.alert(alertType, result.message));
            }

            var incidencia_filter_tipo = $("#dt-incidencia-list_filter-tipo").val();
            var url = '{{ url('incidencia_list_json', { _type: type }) }}';
            var params = '';
            if ($.trim(incidencia_filter_tipo) != '') params += '?tipo='+encodeURIComponent(incidencia_filter_tipo);

            incidencia_list.api().ajax.url(url+params).load();

        }

        function setSelectedItems(work_order_list, type){
            var wrapper = $(work_order_list).closest('.dataTables_wrapper');
            var selectedValues = getSelectedChkItemsIntoSelector(wrapper);
            $('#incidencia_'+type+'_tokens').val(selectedValues.join());
        }
    </script>
{% endblock %}