{% extends 'base.html.twig' %}

{% block page_title %}{{ 'esocial_admin.menu.title.users'|trans }}{% endblock %}
{% block page_breadcrumb %}
    <li class="active">
        <strong>{{ 'esocial_admin.menu.title.users'|trans }}</strong>
    </li>
{% endblock %}
{% block plugins_stylesheets %}
    <link rel="stylesheet" href="{{ asset('bundles/app/ion.rangeSlider-2.1.3/css/ion.rangeSlider.css') }}" />
    <link rel="stylesheet" href="{{ asset('bundles/app/ion.rangeSlider-2.1.3/css/ion.rangeSlider.skinHTML5.css') }}" />
{% endblock %}
{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript" src="{{ asset('bundles/app/ion.rangeSlider-2.1.3/js/ion.rangeSlider.min.js') }}"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBrnM5OyIjcm8FYALdS1KZdE7yKa-x2Iqk" defer></script>
{% endblock %}

{% block body %}
    <div class="ibox">
        <div class="ibox-title">
            <h5>{{ 'esocial_admin.menu.title.users'|trans }}</h5>
        </div>
        <div class="ibox-content">

            <div class="margin-b">
                <a class="btn btn-white" title="{{ 'esocial_admin.screens.users.text.add'|trans }}" href="{{ path('esocial_admin_user_add') }}">
                    <span class="glyphicon glyphicon-plus"></span>
                    <strong>{{ 'esocial_admin.screens.users.actions.add'|trans }}</strong>
                </a>
            </div>

            <table id="dt-user-list" class="table table-striped table-bordered table-hover dataTables-example" >
                <thead>
                <tr>
                    <th class="datatable-chk-cell"><input type="checkbox" class="i-checks datatable-chk-select-all" value="all" /></th>
                    <th>{{ 'esocial_admin.screens.users.datatable.username'|trans }}</th>
                    <th>{{ 'esocial_admin.screens.users.datatable.name'|trans }}</th>
                    <th>{{ 'esocial_admin.screens.users.datatable.surnames'|trans }}</th>
                    <th>{{ 'esocial_admin.screens.users.datatable.role'|trans }}</th>
                    <th>{{ 'esocial_admin.screens.users.datatable.enabled'|trans }}</th>
                    <th>{{ 'esocial_admin.screens.users.datatable.active'|trans }}</th>
                    <th>{{ 'esocial_admin.screens.users.datatable.created_at'|trans }}</th>
                    <th>{{ 'esocial_admin.screens.users.datatable.actions'|trans }}</th>
                </tr>
                </thead>
            </table>
        </div>
    </div>
    <script type="text/javascript">
        var user_list = null;
        $(document).ready(function() {
            var table_columns = [
                {
                    "mData": function (source) {
                        return '<input type="checkbox" class="i-checks" value="'+source.token+'" />';
                    }
                },
                {"mData": "username"},
                {"mData": "name"},
                {"mData": "surnames"},
                {"mData": "role"},
                {
                    "mData": function (source) {
                        return source.enabled ? '<span class="glyphicon glyphicon-ok"></span>' : '';
                    }
                },
                {
                    "mData": function (source) {
                        return source.active ? '<span class="glyphicon glyphicon-ok"></span>' : '';
                    }
                },
                {"mData": "created_at"},
                {
                    "mData": function (source) {

                        var actions = '<a class="btn btn-primary btn-xs" href="' + Routing.generate('esocial_admin_user_edit', { token: source.token, _locale: '{{ app.request.get('_locale') }}' }) + '"><span class="glyphicon glyphicon-edit"></span> &nbsp; {{ 'esocial_admin.screens.users.actions.edit'|trans }}</a>&nbsp; ';
                        if (source.enabled)
                            actions += '<a class="btn btn-primary btn-xs" href="' + Routing.generate('esocial_admin_user_action', { action: 'disable', token: encodeURIComponent(source.token), _locale: '{{ app.request.get('_locale') }}' }) + '"><span class="glyphicon glyphicon-off"></span> &nbsp; {{ 'esocial_admin.screens.users.actions.disable'|trans }}</a>&nbsp; ';
                        else
                            actions += '<a class="btn btn-primary btn-xs" href="' + Routing.generate('esocial_admin_user_action', { action: 'enable', token: encodeURIComponent(source.token), _locale: '{{ app.request.get('_locale') }}' }) + '"><span class="glyphicon glyphicon-off"></span> &nbsp; {{ 'esocial_admin.screens.users.actions.enable'|trans }}</a>&nbsp; ';

                        if (source.active)
                            actions += '<a class="btn btn-primary btn-xs" href="' + Routing.generate('esocial_admin_user_action', { action: 'deactivate', token: encodeURIComponent(source.token), _locale: '{{ app.request.get('_locale') }}' }) + '"><span class="glyphicon glyphicon-minus-sign"></span> &nbsp; {{ 'esocial_admin.screens.users.actions.deactivate'|trans }}</a>&nbsp; ';
                        else
                            actions += '<a class="btn btn-primary btn-xs" href="' + Routing.generate('esocial_admin_user_action', { action: 'activate', token: encodeURIComponent(source.token), _locale: '{{ app.request.get('_locale') }}' }) + '"><span class="glyphicon glyphicon-plus-sign"></span> &nbsp; {{ 'esocial_admin.screens.users.actions.activate'|trans }}</a>&nbsp; ';

                        actions += '<a title="{{ 'menu.title.user.password'|trans }}" class="btn btn-primary btn-xs" onclick="loadAjaxFormPage(this); return false;" href="' + Routing.generate('admin_user_password_edit', { token: source.token, _locale: '{{ app.request.get('_locale') }}' }) + '"><span class="glyphicon glyphicon-edit"></span> &nbsp; {{ 'screens.users.actions.edit_pwd'|trans }}</a>&nbsp; ';

                        actions += '<a title="{{ 'menu.title.user.geo'|trans }}" class="btn btn-primary btn-xs" href="' + Routing.generate('user_view_geo', { token: encodeURIComponent(source.token), _locale: '{{ app.request.get('_locale') }}' }) + '" onclick="loadAjaxPage(this, \'modal-lg\', show_map_makers); return false;"><span class="glyphicon glyphicon-map-marker"></span> &nbsp; {{ 'screens.user.action.view_geo'|trans }}</a>&nbsp; ';

                        return actions;
                    }
                }
            ];

            jQuery(document).ready(function(){
                user_list = TableManaged.init(
                        '#dt-user-list',
                        '{{ url('esocial_admin_user_list_json') }}',
                        null,
                        [0,7],
                        table_columns,
                        '{{ url('datatables_i18n_fragment', { language: app.request.locale }) }}'
                );
            });
        });

        function user_list_reload(){
            user_list.api().ajax.reload();
        }

        var waypoints, wl, markers, hoursRange, gmapApp;
        function show_map_makers(){

            var map_options = { zoom: 12 };
            map_options.center = (waypoints.length > 1) ? { lat: waypoints[0].latitud , lng: waypoints[0].longitud } : { lat: 40.4378271, lng: -3.6795367 };
            gmapApp = new google.maps.Map(document.getElementById("map-canvas"), map_options);

            if(waypoints.length > 0){
                for(var i=0; i < waypoints.length; i++){
                    var marker = null;
                    if (waypoints[i].latitud && waypoints[i].longitud){
                        marker = new google.maps.Marker({
                            position: new google.maps.LatLng(waypoints[i].latitud,waypoints[i].longitud),
                            map: gmapApp,
                            draggable: false,
                            title: waypoints[i].fecha.date
                        });
                        markers.push(marker);
                    }
                }
            }

            if (markers.length > 0) {
                var bounds = new google.maps.LatLngBounds();
                for (var i = 0; i < markers.length; i++) {
                    bounds.extend(markers[i].getPosition());
                }
                gmapApp.fitBounds(bounds);
            }

        }
        function updateMarkers(){
            for(var i=0; i < waypoints.length; i++){
                if (waypoints[i].latitud && waypoints[i].longitud){
                    if (waypoints[i].visible){
                        markers[i].setMap(gmapApp);
                    }else{
                        markers[i].setMap(null);
                    }
                }
            }
        }
        function getDateFromString(str){
            //2015-10-09 20:45:12
            //2015-10-09
            //2015-10-09 20
            //2015-10-09 20:45

            var date_arr = str.split(" ");
            if (date_arr.length < 2){
                return new Date(str);
            }

            var fecha = new Date(date_arr[0]);

            var time_arr = date_arr[1].split(":");
            if (time_arr.length > 0){
                fecha.setHours(time_arr[0]);
            }
            if (time_arr.length > 1){
                fecha.setMinutes(time_arr[1]);
            }
            if (time_arr.length > 2){
                fecha.setSeconds(time_arr[2]);
            }

            return fecha;
        }
        function updateWayPoints(dateFormatted, data){
            var rangeDateFrom = getDateFromString(dateFormatted+" "+hoursRange[data.from]);
            var rangeDateTo = getDateFromString(dateFormatted+" "+hoursRange[data.to]);
            rangeDateFrom.setSeconds(0);
            rangeDateTo.setSeconds(59);

            for(var i=0;i<waypoints.length;i++){
                var waypoint_date = getDateFromString(waypoints[i].fecha.date);
                waypoint_date.setSeconds(0);

                if (waypoint_date.getTime() >= rangeDateFrom.getTime() && waypoint_date.getTime() <= rangeDateTo.getTime()){
                    waypoints[i].visible = true;
                }else{
                    waypoints[i].visible = false;
                }

            }
        }
    </script>
{% endblock %}